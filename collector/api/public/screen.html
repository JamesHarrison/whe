<!DOCTYPE html>
<html>
<head>
  <title>WHE</title>

  <link rel="stylesheet" type="text/css" href="/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="/css/skeleton.css">
  <link rel="stylesheet" type="text/css" href="/css/screen.css">

  <script src="/faye/client.js"></script>

  <script src="/js/jquery.js"></script>
  <script src="/js/ractive.js"></script>
  <script src="/js/lodash.js"></script>
</head>
<body>
  <div id="ui"></div>
  <script id="ui-template" type="text/ractive">
  <div class="wrapper" data-state="{{ isTriggering ? 'is-triggering' : '' }}">
    <div class="masthead">
      <h1>Walls Have Eyes</h1>
      <div class="status">
        Status: monitoring
      </div>
    </div>

    {{#metadata.1}}
    <div class="metadata">
      <dl>
        <dt>Unique device identifier</dt>
        <dd>{{ id || 'Unknown' }}</dd>
        <dt>Manufacturer</dt>
        <dd>{{ company || 'Unknown' }}</dd>
        <dt>Previous networks</dt>
        <dd>{{ aps || 'Unknown' }}</dd>
        <dt>Friends</dt>
        <dd>{{ friends || 'Unknown' }}</dd>
        <dt>Distance</dt>
        <dd>{{ power || 'Unknown' }}</dd>
      </dl>
    </div>
    {{/metadata}}

    <div class="photos">
      <div class="primary">
      {{#primaryImage}}
        <img src="/image/{{name}}" />
      {{/images}}
      </div>
      <div class="secondary">
      {{#secondaryImages}}
        <img src="/image/{{name}}" />
      {{/images}}
      </div>
    </div>
  </div><!-- .wrapper -->

  </script>
  <script>
    $.get('/config').then(initWithConfig);

    function initWithConfig(config) {
      var client = new Faye.Client('http://' + config.collector.host + ':' + config.collector.port + '/faye');
      var ractive = new Ractive({
        el: '#ui',
        template: '#ui-template',
        computed: {
          'imageFiles': function () {
            var images = this.get('images');
            return _(images).pluck('files').flatten().value();
          },
          'primaryImage': function () {
            return this.get('imageFiles').slice(0, 1);
          },
          'secondaryImages': function () {
            return this.get('imageFiles').slice(1);
          }
        },
        data: {
          isTriggering: false
        }
      });

      client.subscribe('/trigger', handleTrigger);
      client.subscribe('/render', handleRender);
      handleRender({}); // Initial render

      function handleTrigger(msg) {
        console.log('TRIGGER', msg);
        ractive.set('isTriggering', true);
      }

      function handleRender(msg) {
        console.log('RENDER', msg);
        $.get('/state')
         .then(function (data) {
            console.log('data', data);
            window.d = data;
            ractive.set(data);
            ractive.set('isTriggering', false);
          });
      }
    }

  </script>
</body>
</html>