<!DOCTYPE html>
<html>
<head>
  <!-- Start iOS Save to homescreen config -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <link href="images/apple-touch-icon-precomposed-152x152.png"
        sizes="152x152"
        rel="apple-touch-icon-precomposed">

  <!-- iPad retina portrait startup image -->
  <link href="images/apple-touch-startup-image-1536x2008.png"
        media="(device-width: 768px) and (device-height: 1024px)
               and (-webkit-device-pixel-ratio: 2)
               and (orientation: portrait)"
        rel="apple-touch-startup-image">

  <!-- iPad retina landscape startup image -->
  <link href="images/apple-touch-startup-image-1496x2048.png"
        media="(device-width: 768px) and (device-height: 1024px)
               and (-webkit-device-pixel-ratio: 2)
               and (orientation: landscape)"
        rel="apple-touch-startup-image">

  <!-- iPad non-retina portrait startup image -->
  <!-- <link href="apple-touch-startup-image-768x1004.png"
        media="(device-width: 768px) and (device-height: 1024px)
               and (-webkit-device-pixel-ratio: 1)
               and (orientation: portrait)"
        rel="apple-touch-startup-image"> -->

  <!-- iPad non-retina landscape startup image -->
  <!-- <link href="apple-touch-startup-image-748x1024.png"
        media="(device-width: 768px) and (device-height: 1024px)
               and (-webkit-device-pixel-ratio: 1)
               and (orientation: landscape)"
        rel="apple-touch-startup-image"> -->
  <!-- End iOS Save to homescreen config -->

  <title>WHE</title>

  <link rel="stylesheet" type="text/css" href="/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="/css/skeleton.css">
  <link rel="stylesheet" type="text/css" href="/css/screen.css">

  <script src="/faye/client.js"></script>

  <script src="/js/jquery.js"></script>
  <script src="/js/ractive.js"></script>
  <script src="/js/lodash.js"></script>
</head>
<body>
  <div id="ui"></div>
  <script id="ui-template" type="text/ractive">
  <div class="wrapper" data-state="{{ isTriggering ? 'is-triggering' : '' }}">
    <div class="masthead">
      <h1>Walls Have Eyes</h1>
      <div class="status">
        Status: monitoring
      </div>
    </div>

    {{#metadata.0}}
    <div class="metadata">
      <dl>
        <dt>Unique device identifier</dt>
        <dd>{{ id || 'Unknown' }}</dd>
        <dt>Manufacturer</dt>
        <dd>{{ company || 'Unknown' }}</dd>
        <dt>Previous networks</dt>
        <dd>{{ aps || 'Unknown' }}</dd>
        <dt>Friends</dt>
        <dd>{{ ~/friends.join(', ') || 'Unknown' }}</dd>
        <dt>Distance</dt>
        <dd>{{ power || 'Unknown' }}</dd>
      </dl>
    </div>
    {{/metadata}}

    <div class="photos">
      <div class="primary">
      {{#primaryImage}}
        <img src="/image/{{name}}" />
      {{/images}}
      </div>
      <div class="secondary">
      {{#secondaryImages}}
        <img src="/image/{{name}}" />
      {{/images}}
      </div>
    </div>
  </div><!-- .wrapper -->

  </script>
  <script>
    var ractive;

    $.get('/config').then(initWithConfig);

    function initWithConfig(config) {
      var client = new Faye.Client('http://' + config.collector.host + ':' + config.collector.port + '/faye');
      ractive = new Ractive({
        el: '#ui',
        template: '#ui-template',
        computed: {
          'imageFiles': function () {
            var images = this.get('images');
            return _(images).pluck('files').flatten().value();
          },
          'primaryImage': function () {
            return this.get('imageFiles').slice(0, 1);
          },
          'secondaryImages': function () {
            return this.get('imageFiles').slice(1);
          },
          'friends': function () {
            return _.pluck( this.get('metadata.0.friends'), 'id' );
          }
        },
        data: {
          isTriggering: false
        }
      });

      client.subscribe('/trigger', handleTrigger);
      client.subscribe('/render', handleRender);
      handleRender({}); // Initial render

      function handleTrigger(msg) {
        console.log('TRIGGER', msg);
        ractive.set('isTriggering', true);
      }

      function handleRender(msg) {
        console.log('RENDER', msg);
        $.get('/state')
         .then(function (data) {
            console.log('data', data);
            window.d = data;
            ractive.set(data);
            ractive.set('isTriggering', false);
          });
      }
    }

  </script>
</body>
</html>